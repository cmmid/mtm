<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.47">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>09. Networks (solutions) – Modern Techniques in Modelling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Modern Techniques in Modelling</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./00_PreCourseMaterial.html"> 
<span class="menu-text">Pre-course</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./timetable.html"> 
<span class="menu-text">Timetable</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-practicals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Practicals</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-practicals">    
        <li>
    <a class="dropdown-item" href="./03_DiscreteDeterministic_practical.html">
 <span class="dropdown-text">03. Discrete-time deterministic models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04_ODEs_practical.html">
 <span class="dropdown-text">04. Ordinary differential equations (ODEs)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05_Metapop_practical.html">
 <span class="dropdown-text">05. Metapopulations with ODEs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06_SensitivitySampling_practical.html">
 <span class="dropdown-text">06. Sensitivity analysis and sampling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./08_StochasticIBM_practical.html">
 <span class="dropdown-text">08. Stochastic individual-based models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09_Networks_practical.html">
 <span class="dropdown-text">09. Networks</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10_StochasticContinuous_practical.html">
 <span class="dropdown-text">10. Stochastic continuous models</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./problems.html"> 
<span class="menu-text">Modelling problems</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#practical-1.-introduction-to-the-igraph-package" id="toc-practical-1.-introduction-to-the-igraph-package" class="nav-link active" data-scroll-target="#practical-1.-introduction-to-the-igraph-package">Practical 1. Introduction to the igraph package</a>
  <ul class="collapse">
  <li><a href="#building-and-plotting-graphs" id="toc-building-and-plotting-graphs" class="nav-link" data-scroll-target="#building-and-plotting-graphs">1. Building and plotting graphs</a></li>
  <li><a href="#getting-and-setting-properties-of-the-graph" id="toc-getting-and-setting-properties-of-the-graph" class="nav-link" data-scroll-target="#getting-and-setting-properties-of-the-graph">2. Getting and setting properties of the graph</a></li>
  <li><a href="#bonus-code-a-network-model" id="toc-bonus-code-a-network-model" class="nav-link" data-scroll-target="#bonus-code-a-network-model">Bonus: Code a network model</a></li>
  </ul></li>
  <li><a href="#practical-2.-a-network-model-of-mpox-transmission" id="toc-practical-2.-a-network-model-of-mpox-transmission" class="nav-link" data-scroll-target="#practical-2.-a-network-model-of-mpox-transmission">Practical 2. A network model of mpox transmission</a>
  <ul class="collapse">
  <li><a href="#setting-up-the-network" id="toc-setting-up-the-network" class="nav-link" data-scroll-target="#setting-up-the-network">Setting up the network</a></li>
  </ul></li>
  <li><a href="#plot-a-network-highlighting-the-degree-of-each-node-by-different-colours." id="toc-plot-a-network-highlighting-the-degree-of-each-node-by-different-colours." class="nav-link" data-scroll-target="#plot-a-network-highlighting-the-degree-of-each-node-by-different-colours.">Plot a network, highlighting the degree of each node by different colours.</a>
  <ul class="collapse">
  <li><a href="#look-at-the-degree-distribution-plotted-for-different-values-of-d" id="toc-look-at-the-degree-distribution-plotted-for-different-values-of-d" class="nav-link" data-scroll-target="#look-at-the-degree-distribution-plotted-for-different-values-of-d">Look at the degree distribution plotted for different values of d</a></li>
  </ul></li>
  <li><a href="#plot-a-network-colouring-by-state-sirv." id="toc-plot-a-network-colouring-by-state-sirv." class="nav-link" data-scroll-target="#plot-a-network-colouring-by-state-sirv.">Plot a network, colouring by state (S/I/R/V).</a>
  <ul class="collapse">
  <li><a href="#test-the-plot_state-function" id="toc-test-the-plot_state-function" class="nav-link" data-scroll-target="#test-the-plot_state-function">Test the plot_state function</a>
  <ul class="collapse">
  <li><a href="#running-the-model" id="toc-running-the-model" class="nav-link" data-scroll-target="#running-the-model">Running the model</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#enact-one-step-of-the-network-model-infectious-individuals-infect" id="toc-enact-one-step-of-the-network-model-infectious-individuals-infect" class="nav-link" data-scroll-target="#enact-one-step-of-the-network-model-infectious-individuals-infect">Enact one step of the network model: infectious individuals infect</a></li>
  <li><a href="#susceptible-neighbours-with-probability-p-and-recover-after-one-time-step." id="toc-susceptible-neighbours-with-probability-p-and-recover-after-one-time-step." class="nav-link" data-scroll-target="#susceptible-neighbours-with-probability-p-and-recover-after-one-time-step.">susceptible neighbours with probability p, and recover after one time step.</a></li>
  <li><a href="#run-the-transmission-model-on-the-network-with-maximum-simulation-time-t_max" id="toc-run-the-transmission-model-on-the-network-with-maximum-simulation-time-t_max" class="nav-link" data-scroll-target="#run-the-transmission-model-on-the-network-with-maximum-simulation-time-t_max">Run the transmission model on the network with maximum simulation time t_max</a></li>
  <li><a href="#and-transmission-probability-p-plot-the-network-as-the-model-is-running-if" id="toc-and-transmission-probability-p-plot-the-network-as-the-model-is-running-if" class="nav-link" data-scroll-target="#and-transmission-probability-p-plot-the-network-as-the-model-is-running-if">and transmission probability p; plot the network as the model is running if</a></li>
  <li><a href="#animate-true." id="toc-animate-true." class="nav-link" data-scroll-target="#animate-true.">animate = TRUE.</a>
  <ul class="collapse">
  <li><a href="#run-an-example-simulation" id="toc-run-an-example-simulation" class="nav-link" data-scroll-target="#run-an-example-simulation">Run an example simulation</a>
  <ul class="collapse">
  <li><a href="#bonus-material-vaccination-and-multiple-runs" id="toc-bonus-material-vaccination-and-multiple-runs" class="nav-link" data-scroll-target="#bonus-material-vaccination-and-multiple-runs">Bonus material: vaccination and multiple runs</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#vaccinate-a-fraction-v-of-the-nodes-in-the-network.-the-parameter-k-between" id="toc-vaccinate-a-fraction-v-of-the-nodes-in-the-network.-the-parameter-k-between" class="nav-link" data-scroll-target="#vaccinate-a-fraction-v-of-the-nodes-in-the-network.-the-parameter-k-between">Vaccinate a fraction v of the nodes in the network. The parameter k, between</a></li>
  <li><a href="#and-1-determines-the-association-between-network-degree-and-vaccination." id="toc-and-1-determines-the-association-between-network-degree-and-vaccination." class="nav-link" data-scroll-target="#and-1-determines-the-association-between-network-degree-and-vaccination.">-1 and 1, determines the association between network degree and vaccination.</a></li>
  <li><a href="#run-the-model-nsim-times-with-parameters-in-params-n-d-v-k-t_max-p" id="toc-run-the-model-nsim-times-with-parameters-in-params-n-d-v-k-t_max-p" class="nav-link" data-scroll-target="#run-the-model-nsim-times-with-parameters-in-params-n-d-v-k-t_max-p">Run the model nsim times with parameters in params (n, d, v, k, t_max, p),</a></li>
  <li><a href="#showing-the-animated-network-the-first-nanim-times-and-returning-a-data.table" id="toc-showing-the-animated-network-the-first-nanim-times-and-returning-a-data.table" class="nav-link" data-scroll-target="#showing-the-animated-network-the-first-nanim-times-and-returning-a-data.table">showing the animated network the first nanim times, and returning a data.table</a></li>
  <li><a href="#with-the-results-of-each-simulation." id="toc-with-the-results-of-each-simulation." class="nav-link" data-scroll-target="#with-the-results-of-each-simulation.">with the results of each simulation.</a>
  <ul class="collapse">
  <li><a href="#test-multiple-runs" id="toc-test-multiple-runs" class="nav-link" data-scroll-target="#test-multiple-runs">Test multiple runs</a></li>
  </ul></li>
  <li><a href="#do-a-test-run" id="toc-do-a-test-run" class="nav-link" data-scroll-target="#do-a-test-run">Do a test run!</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">09. Networks (solutions)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="practical-1.-introduction-to-the-igraph-package" class="level2">
<h2 class="anchored" data-anchor-id="practical-1.-introduction-to-the-igraph-package">Practical 1. Introduction to the igraph package</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph) <span class="co"># For network functionality</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'igraph' was built under R version 4.2.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="building-and-plotting-graphs" class="level3">
<h3 class="anchored" data-anchor-id="building-and-plotting-graphs">1. Building and plotting graphs</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Complete graph with 4 nodes</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">&lt;-</span> <span class="fu">make_full_graph</span>(<span class="dv">4</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IGRAPH 78443be U--- 4 6 -- Full graph
+ attr: name (g/c), loops (g/l)
+ edges from 78443be:
[1] 1--2 1--3 1--4 2--3 2--4 3--4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Plot different graphs each with 16 vertices, but different connections between vertices:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">&lt;-</span> <span class="fu">make_full_graph</span>(<span class="dv">16</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">&lt;-</span> <span class="fu">make_ring</span>(<span class="dv">16</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">&lt;-</span> <span class="fu">make_ring</span>(<span class="dv">16</span>, <span class="at">circular =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-3-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">&lt;-</span> <span class="fu">make_lattice</span>(<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-3-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compare a connected graph with 16 vertices to an Erdős-Rényi G(n, p) graph with 16 vertices:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">make_full_graph</span>(<span class="dv">16</span>), <span class="at">layout =</span> layout_in_circle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">sample_gnp</span>(<span class="dv">16</span>, <span class="fl">0.2</span>), <span class="at">layout =</span> layout_in_circle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Other random graphs: The “small-world” model by Watts and Strogatz, where there are connections between neighbours, some of which are randomly rewired:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">sample_smallworld</span>(<span class="dv">1</span>, <span class="dv">16</span>, <span class="dv">2</span>, <span class="fl">0.1</span>), <span class="at">layout =</span> layout_in_circle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The “preferential attachment” model by Barabási and Albert, which is built by adding nodes one at a time, and each time a node is added, it is connected to other nodes, where the connection is more likely to be made to a node that already has more connections (a “rich get richer” dynamic).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">sample_pa</span>(<span class="dv">16</span>, <span class="at">directed =</span> <span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="getting-and-setting-properties-of-the-graph" class="level3">
<h3 class="anchored" data-anchor-id="getting-and-setting-properties-of-the-graph">2. Getting and setting properties of the graph</h3>
<p>Start by making a new ‘lattice’ graph:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>network <span class="ot">&lt;-</span> <span class="fu">make_lattice</span>(<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IGRAPH b36dbbd U--- 25 40 -- Lattice graph
+ attr: name (g/c), dimvector (g/n), nei (g/n), mutual (g/l), circular
| (g/l)
+ edges from b36dbbd:
 [1]  1-- 2  1-- 6  2-- 3  2-- 7  3-- 4  3-- 8  4-- 5  4-- 9  5--10  6-- 7
[11]  6--11  7-- 8  7--12  8-- 9  8--13  9--10  9--14 10--15 11--12 11--16
[21] 12--13 12--17 13--14 13--18 14--15 14--19 15--20 16--17 16--21 17--18
[31] 17--22 18--19 18--23 19--20 19--24 20--25 21--22 22--23 23--24 24--25</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Some simple calculations: <code>vcount()</code> or <code>ecount()</code> give the number of vertices or edges in the graph; <code>degree()</code> gives the number of neighbours of each vertex.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vcount</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 25</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ecount</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 40</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">degree</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2 3 3 3 2 3 4 4 4 3 3 4 4 4 3 3 4 4 4 3 2 3 3 3 2</code></pre>
</div>
</div>
<p>With <code>igraph</code>, you can get and set attributes of the entire graph using the <code>$</code> operator. For example, let’s set the graph’s layout to a grid:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>network<span class="sc">$</span>layout <span class="ot">&lt;-</span> <span class="fu">layout_on_grid</span>(network)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IGRAPH b36dbbd U--- 25 40 -- Lattice graph
+ attr: name (g/c), dimvector (g/n), nei (g/n), mutual (g/l), circular
| (g/l), layout (g/n)
+ edges from b36dbbd:
 [1]  1-- 2  1-- 6  2-- 3  2-- 7  3-- 4  3-- 8  4-- 5  4-- 9  5--10  6-- 7
[11]  6--11  7-- 8  7--12  8-- 9  8--13  9--10  9--14 10--15 11--12 11--16
[21] 12--13 12--17 13--14 13--18 14--15 14--19 15--20 16--17 16--21 17--18
[31] 17--22 18--19 18--23 19--20 19--24 20--25 21--22 22--23 23--24 24--25</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can also modify properties of the vertices and of the edges, using <code>V()</code> and <code>E()</code> respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="st">"azure"</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">E</span>(network)<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="st">"pink"</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(network) <span class="co"># lovely</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can use <code>V(network)[[]]</code> or <code>E(network)[[]]</code> to see the properties of the vertices/edges laid out as a data frame:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)[[]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+ 25/25 vertices, from b36dbbd:
   color
1  azure
2  azure
3  azure
4  azure
5  azure
6  azure
7  azure
8  azure
9  azure
10 azure
11 azure
12 azure
13 azure
14 azure
15 azure
16 azure
17 azure
18 azure
19 azure
20 azure
21 azure
22 azure
23 azure
24 azure
25 azure</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">E</span>(network)[[]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+ 40/40 edges from b36dbbd:
   tail head tid hid color
1     1    2   1   2  pink
2     1    6   1   6  pink
3     2    3   2   3  pink
4     2    7   2   7  pink
5     3    4   3   4  pink
6     3    8   3   8  pink
7     4    5   4   5  pink
8     4    9   4   9  pink
9     5   10   5  10  pink
10    6    7   6   7  pink
11    6   11   6  11  pink
12    7    8   7   8  pink
13    7   12   7  12  pink
14    8    9   8   9  pink
15    8   13   8  13  pink
16    9   10   9  10  pink
17    9   14   9  14  pink
18   10   15  10  15  pink
19   11   12  11  12  pink
20   11   16  11  16  pink
21   12   13  12  13  pink
22   12   17  12  17  pink
23   13   14  13  14  pink
24   13   18  13  18  pink
25   14   15  14  15  pink
26   14   19  14  19  pink
27   15   20  15  20  pink
28   16   17  16  17  pink
29   16   21  16  21  pink
30   17   18  17  18  pink
31   17   22  17  22  pink
32   18   19  18  19  pink
33   18   23  18  23  pink
34   19   20  19  20  pink
35   19   24  19  24  pink
36   20   25  20  25  pink
37   21   22  21  22  pink
38   22   23  22  23  pink
39   23   24  23  24  pink
40   24   25  24  25  pink</code></pre>
</div>
</div>
<p>The “color” attribute is now also listed when we print the network:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>network</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IGRAPH b36dbbd U--- 25 40 -- Lattice graph
+ attr: name (g/c), dimvector (g/n), nei (g/n), mutual (g/l), circular
| (g/l), layout (g/n), color (v/c), color (e/c)
+ edges from b36dbbd:
 [1]  1-- 2  1-- 6  2-- 3  2-- 7  3-- 4  3-- 8  4-- 5  4-- 9  5--10  6-- 7
[11]  6--11  7-- 8  7--12  8-- 9  8--13  9--10  9--14 10--15 11--12 11--16
[21] 12--13 12--17 13--14 13--18 14--15 14--19 15--20 16--17 16--21 17--18
[31] 17--22 18--19 18--23 19--20 19--24 20--25 21--22 22--23 23--24 24--25</code></pre>
</div>
</div>
<p>Finally, we can also use brackets [] to change properties of only certain vertices/edges.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)[<span class="dv">12</span>]<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)[color <span class="sc">==</span> <span class="st">"orange"</span>]<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="st">"pink"</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Pink is contagious:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)[<span class="fu">.nei</span>(color <span class="sc">==</span> <span class="st">"pink"</span>)]<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="st">"pink"</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>What happens if you re-run the last two lines above several times?<br>
<strong>Answer:</strong> The number of pink points in this network gradually increase.</p>
<p>Other interesting attributes for vertices include:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)<span class="sc">$</span>label <span class="ot">&lt;-</span> <span class="cn">NA</span>        <span class="co"># text label for the vertices (set to NA for no labels)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">5</span>          <span class="co"># size of vertex markers</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)<span class="sc">$</span>shape <span class="ot">&lt;-</span> <span class="st">"square"</span>  <span class="co"># shape of markers</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># See ?igraph.plotting for more.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="bonus-code-a-network-model" class="level3">
<h3 class="anchored" data-anchor-id="bonus-code-a-network-model">Bonus: Code a network model</h3>
<p>Here is one possible way of doing it…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>network <span class="ot">&lt;-</span> <span class="fu">make_lattice</span>(<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Set all vertices to “susceptible” except for one “infected”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)<span class="sc">$</span>state <span class="ot">&lt;-</span> <span class="st">"S"</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(network)[<span class="dv">1</span>]<span class="sc">$</span>state <span class="ot">&lt;-</span> <span class="st">"I"</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick plotting colours</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"lightblue"</span>, <span class="at">I =</span> <span class="st">"red"</span>, <span class="at">R =</span> <span class="st">"pink"</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print and loop through time steps</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>t_max <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>t_max)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot network</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(network, </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">vertex.color =</span> colours[<span class="fu">V</span>(network)<span class="sc">$</span>state], </span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">layout =</span> layout_on_grid,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"t = ,"</span>, t))</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pause so we can see animation</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fl">1.0</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find "infector" vertices</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    infectors <span class="ot">&lt;-</span> <span class="fu">V</span>(network)[state <span class="sc">==</span> <span class="st">"I"</span>]</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Infect susceptible neighbours of infectors</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">V</span>(network)[<span class="fu">.nei</span>(infectors) <span class="sc">&amp;</span> state <span class="sc">==</span> <span class="st">"S"</span>]<span class="sc">$</span>state <span class="ot">&lt;-</span> <span class="st">"I"</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recover infectors</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">V</span>(network)[infectors]<span class="sc">$</span>state <span class="ot">&lt;-</span> <span class="st">"R"</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-7.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-8.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-9.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-17-10.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="practical-2.-a-network-model-of-mpox-transmission" class="level2">
<h2 class="anchored" data-anchor-id="practical-2.-a-network-model-of-mpox-transmission">Practical 2. A network model of mpox transmission</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="setting-up-the-network" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-the-network">Setting up the network</h3>
<p>Set up a transmission network of n nodes by preferential attachment with affinity proportional to degree^m.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>create_network <span class="ot">&lt;-</span> <span class="cf">function</span>(n, d, <span class="at">layout =</span> layout_nicely)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the network by preferential attachment, passing on the parameters </span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n and power</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    network <span class="ot">&lt;-</span> <span class="fu">sample_pa</span>(n, d, <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the "state" attribute to the vertices of the network, which can be</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "S", "I", "R", or "V". </span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start out everyone as susceptible ...</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">V</span>(network)<span class="sc">$</span>state <span class="ot">&lt;-</span> <span class="st">"S"</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... except make 5 random individuals infectious.</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">V</span>(network)<span class="sc">$</span>state[<span class="fu">sample</span>(<span class="fu">vcount</span>(network), <span class="dv">5</span>, <span class="at">prob =</span> <span class="fu">degree</span>(network))] <span class="ot">&lt;-</span> <span class="st">"I"</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reorder vertices so they go in order from least to most connected. This</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># is to help with degree-targeted vaccination, and also to make the </span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># most connected vertices plot on top so they don't get hidden. </span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    network <span class="ot">&lt;-</span> <span class="fu">permute</span>(network, <span class="fu">rank</span>(<span class="fu">degree</span>(network), <span class="at">ties.method =</span> <span class="st">"first"</span>))</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the network layout so it doesn't change every time it's plotted.</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    network<span class="sc">$</span>layout <span class="ot">&lt;-</span> <span class="fu">layout</span>(network)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> (network)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="do">## See how the parameter d to create_network changes the network structure</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>net <span class="ot">&lt;-</span> <span class="fu">create_network</span>(<span class="dv">40</span>, <span class="dv">0</span>)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(net)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>net <span class="ot">&lt;-</span> <span class="fu">create_network</span>(<span class="dv">40</span>, <span class="dv">1</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(net)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>net <span class="ot">&lt;-</span> <span class="fu">create_network</span>(<span class="dv">40</span>, <span class="dv">2</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(net)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_Networks_solutions_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="plot-a-network-highlighting-the-degree-of-each-node-by-different-colours." class="level1">
<h1>Plot a network, highlighting the degree of each node by different colours.</h1>
<p>plot_degree &lt;- function(network) { # Set up palette colors &lt;- hcl.colors(5, “Zissou 1”)</p>
<pre><code># Classify nodes by degree
deg &lt;- cut(degree(network), 
    breaks = c(1, 2, 5, 10, 20, Inf),
    labels = c("1", "2-4", "5-9", "10-19", "20+"),
    include.lowest = TRUE, right = FALSE)

# Plot network
plot(network, 
    vertex.color = colors[deg],
    vertex.label = NA,
    vertex.size = 4)
legend("topright", levels(deg), fill = colors, title = "Degree")</code></pre>
<p>}</p>
<section id="look-at-the-degree-distribution-plotted-for-different-values-of-d" class="level2">
<h2 class="anchored" data-anchor-id="look-at-the-degree-distribution-plotted-for-different-values-of-d">Look at the degree distribution plotted for different values of d</h2>
<p>net &lt;- create_network(500, 1) plot_degree(net)</p>
<p>net &lt;- create_network(500, 1.5) plot_degree(net)</p>
<p>net &lt;- create_network(500, 2) plot_degree(net)</p>
</section>
</section>
<section id="plot-a-network-colouring-by-state-sirv." class="level1">
<h1>Plot a network, colouring by state (S/I/R/V).</h1>
<p>plot_state &lt;- function(network) { # Set up palette colors &lt;- c(S = “lightblue”, I = “red”, R = “darkblue”, V = “white”)</p>
<pre><code># Plot network
plot(network, 
    vertex.color = colors[V(network)$state], 
    vertex.label = NA,
    vertex.size = 4)
legend("topright", names(colors), fill = colors, title = "State")</code></pre>
<p>}</p>
<section id="test-the-plot_state-function" class="level2">
<h2 class="anchored" data-anchor-id="test-the-plot_state-function">Test the plot_state function</h2>
<p>net &lt;- create_network(500, 1) plot_state(net)</p>
<section id="running-the-model" class="level3">
<h3 class="anchored" data-anchor-id="running-the-model">Running the model</h3>
</section>
</section>
</section>
<section id="enact-one-step-of-the-network-model-infectious-individuals-infect" class="level1">
<h1>Enact one step of the network model: infectious individuals infect</h1>
</section>
<section id="susceptible-neighbours-with-probability-p-and-recover-after-one-time-step." class="level1">
<h1>susceptible neighbours with probability p, and recover after one time step.</h1>
<p>network_step &lt;- function(net, p) { # Identify all susceptible neighbours of infectious individuals, # who are “at risk” of infection at_risk &lt;- V(net)[state == “S” &amp; .nei(state == “I”)]</p>
<pre><code># Use the transmission probability to select who gets exposed from
# among those at risk
exposed &lt;- at_risk[runif(length(at_risk)) &lt; p]

# All currently infectious individuals will recover
V(net)[state == "I"]$state &lt;- "R"

# All exposed individuals become infectious
V(net)[exposed]$state &lt;- "I"

return (net)</code></pre>
<p>}</p>
</section>
<section id="run-the-transmission-model-on-the-network-with-maximum-simulation-time-t_max" class="level1">
<h1>Run the transmission model on the network with maximum simulation time t_max</h1>
</section>
<section id="and-transmission-probability-p-plot-the-network-as-the-model-is-running-if" class="level1">
<h1>and transmission probability p; plot the network as the model is running if</h1>
</section>
<section id="animate-true." class="level1">
<h1>animate = TRUE.</h1>
<p>run_model &lt;- function(net, t_max, p, animate = FALSE) { # Plot network degree if (animate) { plot_degree(net) Sys.sleep(2.0) }</p>
<pre><code># Set up results
dt &lt;- list()

# Iterate over each time step
for (t in 0:t_max)
{
    # Store results
    dt[[length(dt) + 1]] &lt;- data.table(
        S = sum(V(net)$state == "S"),
        I = sum(V(net)$state == "I"),
        R = sum(V(net)$state == "R"),
        V = sum(V(net)$state == "V")
    )

    # Plot current state
    if (animate) {
        Sys.sleep(0.5)
        plot_state(net)
    }
    
    # Stop early if no infectious individuals are left
    if (!any(V(net)$state == "I")) {
        break;
    }

    # Run one step of the network model
    net &lt;- network_step(net, p)
}

# Return results, including empirical calculation of Rt
results &lt;- rbindlist(dt, idcol = "t")
results$Rt &lt;- results$I / shift(results$I, 1) # new infections per new infection last time step
return (results)</code></pre>
<p>}</p>
<section id="run-an-example-simulation" class="level2">
<h2 class="anchored" data-anchor-id="run-an-example-simulation">Run an example simulation</h2>
<p>net &lt;- create_network(500, 1) run_model(net, 100, 0.8, TRUE)</p>
<section id="bonus-material-vaccination-and-multiple-runs" class="level3">
<h3 class="anchored" data-anchor-id="bonus-material-vaccination-and-multiple-runs">Bonus material: vaccination and multiple runs</h3>
</section>
</section>
</section>
<section id="vaccinate-a-fraction-v-of-the-nodes-in-the-network.-the-parameter-k-between" class="level1">
<h1>Vaccinate a fraction v of the nodes in the network. The parameter k, between</h1>
</section>
<section id="and-1-determines-the-association-between-network-degree-and-vaccination." class="level1">
<h1>-1 and 1, determines the association between network degree and vaccination.</h1>
<p>vaccinate_network &lt;- function(network, v, k) { # Count total population (n) and number to vaccinate (nv) n &lt;- vcount(network) nv &lt;- rbinom(1, n, v)</p>
<pre><code># If k &gt; 0, vaccinate the nv most-connected individuals; if k &lt;= 0, 
# vaccinate the nv least-connected individuals.
if (k &gt; 0) {
    target &lt;- (n - nv + 1):n
} else {
    target &lt;- 1:nv
}
V(network)[target]$state &lt;- "V"

# Now randomly shuffle the state of a fraction 1 - abs(k) of individuals.
shuffle &lt;- which(rbinom(n, 1, 1 - abs(k)) == 1)
V(network)[shuffle]$state &lt;- sample(V(network)[shuffle]$state)

return (network)</code></pre>
<p>}</p>
</section>
<section id="run-the-model-nsim-times-with-parameters-in-params-n-d-v-k-t_max-p" class="level1">
<h1>Run the model nsim times with parameters in params (n, d, v, k, t_max, p),</h1>
</section>
<section id="showing-the-animated-network-the-first-nanim-times-and-returning-a-data.table" class="level1">
<h1>showing the animated network the first nanim times, and returning a data.table</h1>
</section>
<section id="with-the-results-of-each-simulation." class="level1">
<h1>with the results of each simulation.</h1>
<p>run_scenario &lt;- function(params, nsim, nanim = 1) { results &lt;- list()</p>
<pre><code>for (sim in 1:nsim)
{
    net &lt;- create_network(params$n, params$d)
    net &lt;- vaccinate_network(net, params$v, params$k)

    results[[sim]] &lt;- run_model(net, params$t_max, params$p, animate = sim &lt;= nanim)
    
    cat(".")
}
cat("\n");

results &lt;- rbindlist(results, idcol = "run")
return (results)</code></pre>
<p>}</p>
<section id="test-multiple-runs" class="level2">
<h2 class="anchored" data-anchor-id="test-multiple-runs">Test multiple runs</h2>
<p>params &lt;- list( n = 500, d = 0, p = 0.8, v = 0.3, k = -0.5, t_max = 100 )</p>
</section>
</section>
<section id="do-a-test-run" class="level1">
<h1>Do a test run!</h1>
<p>x &lt;- run_scenario(params, nsim = 50) ggplot(x) + geom_line(aes(x = t, y = R, group = run)) ```</p>
<p><strong>Return to the practical <a href="./09_Networks_practical.html">here</a>.</strong></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>